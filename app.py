import streamlit as st
import pandas as pd
from streamlit_gsheets import GSheetsConnection
from datetime import datetime, timedelta

# ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ
st.set_page_config(page_title="ูุธุงู ุฅุฏุงุฑุฉ ูุคุดุฑุงุช ุงูุญุฑู", layout="wide")

conn = st.connection("gsheets", type=GSheetsConnection)

def get_data():
    return conn.read(ttl=2)

# --- ุฅุนุฏุงุฏุงุช ุงูููุช ุงูุฏููุงููููุฉ ---
arabic_months = {
    1: "ููุงูุฑ", 2: "ูุจุฑุงูุฑ", 3: "ูุงุฑุณ", 4: "ุฃุจุฑูู", 5: "ูุงูู", 6: "ููููู",
    7: "ููููู", 8: "ุฃุบุณุทุณ", 9: "ุณุจุชูุจุฑ", 10: "ุฃูุชูุจุฑ", 11: "ููููุจุฑ", 12: "ุฏูุณูุจุฑ"
}

# ุญุณุงุจ ุงูุดูุฑ ุงููุณุชูุฏู (ุงูููู - 20 ููู) ููุง ุทูุจุช
target_date = datetime.today() - timedelta(days=20)
current_month_name = arabic_months[target_date.month]
current_year = target_date.year

# ุงุณู ุงูุนููุฏ ุงูุฏููุงูููู ุงูุฐู ุณูุธูุฑ ูู ุงูุฅุฏุฎุงู ููู ุงูุฌุฏูู
dynamic_column_name = f"ุงููููุฉ ุงููุนููุฉ {current_month_name} {current_year}"

# --- ุงูุจูุงูุงุช ุงูุซุงุจุชุฉ ---
INDICATORS = [
    "ูุณุจุฉ ุฅุบูุงู ุงูุทูุจุงุช ุงููุงุฑุฏุฉ ูู ููุตุฉ ุฃุจุฏุน ููุชุฑุงุฎูุต ุงูุญุฑููุฉ", "ุนุฏุฏ ุงูุฑุฎุต ุงููุตุฏุฑุฉ ูู ุฑุฎุตุฉ ููุงุฑุณ ุญุฑูู",
    "ุนุฏุฏ ุงูุฑุฎุต ุงููุตุฏุฑุฉ ูู ุฑุฎุตุฉ ูุญู ุจูุน ููุชุฌุงุช ุญุฑููุฉ ุชุฑุงุซูุฉ ูุฏููุฉ", "ุนุฏุฏ ุงูุญุฑูููู ุงููุณุฌููู ูู ุงูุณุฌู ุงููุทูู ููุญุฑูููู",
    "ุนุฏุฏ ุงููุชุจ ุนู ุงูุญุฑู ุงููุฏููุฉ", "ุนุฏุฏ ุงูุจุญูุซ ุนู ุงูุญุฑู ุงููุฏููุฉ", "ุนุฏุฏ ุงูุจููุช ุงูุญุฑููุฉ ุงููุดุทุฉ",
    "ุนุฏุฏ ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ููุฑุด ุงูุนูู ููุจููุช ุงูุญุฑููุฉ ููุท", "ุนุฏุฏ ุงููุณุชููุฏูู ุงูุญุงูููู ูู ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ุงูููุฏูุฉ ููุจููุช ุงูุญุฑููุฉ ููุท",
    "ุนุฏุฏ ุงููุชุฏุงูุชูู ุฎูุงู ุจุฏุงูุฉ ูุฑุญูุฉ ุชุฏุฑูุจูุฉ ููุจููุช ุงููุงุฆูุฉ", "ุนุฏุฏ ุงูุฎุฑูุฌูู ูู ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ุงูููุฏูุฉ ูู ุงูุจููุช ุงูุญุฑููุฉ ููุท",
    "ุนุฏุฏ ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ููุฑุด ุงูุนูู ููุงูุฉ ุงููุดุงุฑูุน ุฏูู ุงูุจููุช ุงูุญุฑููุฉ", "ุนุฏุฏ ุงููุณุชููุฏูู ูู ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ุงูููุฏูุฉ ููุงูุฉ ุงููุดุงุฑูุน ุฏูู ุงูุจููุช ุงูุญุฑููุฉ",
    "ุนุฏุฏ ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ููุฑุด ุงูุนูู ููุฃุทูุงู", "ุนุฏุฏ ุงููุณุชููุฏูู ูู ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ููุฑุด ุงูุนูู ุงูููุฏูุฉ ููุฃุทูุงู",
    "ุนุฏุฏ ุงููุทุน ุงูุญุฑููุฉ ุงูููุชุฌุฉ ูู ุฃุนูุงู ุงูุจููุช ุงูุญุฑููุฉ", "ุนุฏุฏ ุงููุทุน ุงูุญุฑููุฉ ุงูููุชุฌุฉ ูู ุฃุนูุงู ููุดุงุฑูุน ุงููุทุงุน",
    "ุนุฏุฏ ุงูุชุตุงููู ุงูุตุงุฏุฑุฉ ูู ูุดุงุฑูุน ุงูุจููุช ุงูุญุฑููุฉ", "ุนุฏุฏ ุงูุชุตุงููู ุงูุตุงุฏุฑุฉ ูู ูุงูุฉ ูุดุงุฑูุน ูุทุงุน ุงูุญุฑู",
    "ุนุฏุฏ ุงููุนุงุฑุถ ูุงููุนุงููุงุช ุงูุฏูููุฉ", "ุนุฏุฏ ุงููุนุงุฑุถ ูุงููุนุงููุงุช ุงููุญููุฉ", "ุนุฏุฏ ุงูุญุฑูููู ุงููุดุงุฑููู ูู ุงููุนุงุฑุถ ุงูุฏูููุฉ",
    "ุนุฏุฏ ุงูุญุฑูููู ุงููุดุงุฑููู ูู ุงููุนุงุฑุถ ุงููุญููุฉ", "ุนุฏุฏ ุงูุญุฑูููู ุงููุฏุนูููู ููุฌุณุชูุงู", "ุนุฏุฏ ุงููุทุงุนุงุช ุบูุฑ ุงูุฑุจุญูุฉ ุงููุณุชููุฏุฉ",
    "ุนุฏุฏ ุงูุฌูุงุฆุฒ ุงููุชูุฏู ุนูููุง ูุทุงุน ุงูุญุฑู", "ุนุฏุฏ ุงูุฌูุงุฆุฒ ุงูุญุงุตู ุนูููุง ูุทุงุน ุงูุญุฑู", "ุนุฏุฏ ุงููุดุงุฑูุงุช ุงูุจุญุซูุฉ",
    "ุนุฏุฏ ุงูุญุฑูููู ุงููุณุชููุฏูู ูู ุงูุฏุนู ุงููุงูู", "ูููุฉ ุงูุฏุนู ุงููุงูู ุงูููุฏู", "ุนุฏุฏ ุงูุญุฑูููู ุงููุณุชููุฏูู ูู ุฏุนู ุงููุนุงููุงุช",
    "ูููุฉ ุงูุฏุนู ุงููุงูู ุนุจุฑ ุงููุนุงููุงุช", "ุนุฏุฏ ุงูููุงูุงุช ุงููุณุชููุฏุฉ ูู ุงูุฏุนู", "ูููุฉ ุงูุฏุนู ุงููุงูู ููููุงูุงุช"
]

FOLLOW_UP_LIST = ["ุดูุฑู","ุชุฑุงููู","ุชุฑุงููู","ุชุฑุงููู"] + ["ุดูุฑู"]*24 + ["ุฑุจุนู"]*6
FOLLOW_UP_MAPPING = dict(zip(INDICATORS, FOLLOW_UP_LIST))
OWNERS = ["ูุญูุฏ ุงูุนุซูุงู","ุญูุงู ุงูุตุญู","ุงููููู ุงููุนุจูู","ุฏููุง ุงูุญููุฏู","ุฑูู ุงูุญููุฏ","ููุง ุงูุบุงููู","ุตุงูุญ ุจู ุฏุฑููู","ุนุจุฏุงููู ุงูุฑุจููุน","ููุงู ุงูุฑุงุฌุญู"]

# --- ูุธุงู ุงูุญูุงูุฉ ---
def check_password():
    if "user_role" not in st.session_state: st.session_state["user_role"] = None
    def password_entered():
        pwd = st.session_state["password"]
        if pwd == "1111":
            st.session_state["user_role"], st.session_state["password_correct"] = "user", True
        elif pwd == "2222":
            st.session_state["user_role"], st.session_state["password_correct"] = "admin", True
        else: st.session_state["password_correct"] = False
        if "password" in st.session_state: del st.session_state["password"]
    if not st.session_state.get("password_correct"):
        st.text_input("ุฃุฏุฎู ุงูุฑูุฒ ุงูุณุฑู ููุฏุฎูู", type="password", on_change=password_entered, key="password")
        return False
    return True

if not check_password(): st.stop()

# --- ุฅุฏุงุฑุฉ ุงูุชุจููุจุงุช ---
role = st.session_state["user_role"]
if role == "admin": tab1, tab2 = st.tabs(["โ ุฅุถุงูุฉ ุจูุงูุงุช", "๐ ุนุฑุถ ูุชุนุฏูู ูุฅุฏุงุฑุฉ"])
else: tab1, tab2 = st.container(), None

with tab1:
    st.title("๐ ูุธุงู ุฅุฏุงุฑุฉ ูุคุดุฑุงุช ูุทุงุน ุงูุญุฑู")
    st.subheader(f"ุฅุฏุฎุงู ุจูุงูุงุช ุดูุฑ: {current_month_name} {current_year}")
    
    ind_name = st.selectbox("ุงุณู ุงููุคุดุฑ", INDICATORS)
    f_method = FOLLOW_UP_MAPPING.get(ind_name, "ุบูุฑ ูุญุฏุฏ")
    st.info(f"ุทุฑููุฉ ุงููุชุงุจุนุฉ: **{f_method}** | ุงููุชุฑุฉ ุงููุณุชูุฏูุฉ: **{current_month_name}**")

    with st.form("add_form", clear_on_submit=True):
        c1, c2 = st.columns(2)
        with c1:
            owner_name = st.selectbox("ูุงูู ุงููุคุดุฑ", OWNERS)
            base_24 = st.number_input("ุฎุท ุงูุฃุณุงุณ 2024", value=0.0)
        with c2:
            # ููุง ุงูุชุบููุฑ: ุงุณู ุงูุญูู ุฃุตุจุญ ุฏููุงููููุงู
            act_val = st.number_input(f"{dynamic_column_name}", value=0.0)
            docs_input = st.text_input("ุงููุซุงุฆู ุงูุฏุงุนูุฉ")

        if st.form_submit_button("ุญูุธ ูู ุงูุณุญุงุจุฉ โ"):
            with st.spinner('ุฌุงุฑู ุชุญุฏูุซ ุงูุณุฌูุงุช...'):
                current_df = get_data()
                
                # ุฅูุดุงุก ุงูุณุฌู ุงูุฌุฏูุฏ
                new_data = {
                    "ุงุณู ุงููุคุดุฑ": ind_name, 
                    "ูุงูู ุงููุคุดุฑ": owner_name,
                    "ุฎุท ุงูุฃุณุงุณ 2024": base_24, 
                    "ุงููุซุงุฆู ุงูุฏุงุนูุฉ": docs_input, 
                    "ุทุฑููุฉ ุงููุชุงุจุนุฉ": f_method,
                    dynamic_column_name: act_val # ุฅุถุงูุฉ ุงููููุฉ ููุนููุฏ ุงูุฌุฏูุฏ
                }
                
                # ููุทู ุงูุชุญุฏูุซ: ุฅุฐุง ูุฌุฏูุง ููุณ ุงููุคุดุฑ ูุงููุงููุ ูุญุฏุซ ุงูุณุทุฑุ ูุฅูุง ูุถูู ุณุทุฑ ุฌุฏูุฏ
                mask = (current_df['ุงุณู ุงููุคุดุฑ'] == ind_name) & (current_df['ูุงูู ุงููุคุดุฑ'] == owner_name)
                
                if mask.any():
                    # ุชุญุฏูุซ ุงูุนููุฏ ุงูุฌุฏูุฏ ูู ุงูุณุทุฑ ุงูููุฌูุฏ
                    current_df.loc[mask, dynamic_column_name] = act_val
                    updated_df = current_df
                else:
                    # ุฅุถุงูุฉ ุณุทุฑ ุฌุฏูุฏ ุชูุงูุงู
                    new_row = pd.DataFrame([new_data])
                    updated_df = pd.concat([current_df, new_row], ignore_index=True)
                
                conn.update(data=updated_df)
                st.cache_data.clear()
            st.success(f"ุชู ุญูุธ ุจูุงูุงุช {current_month_name} ุจูุฌุงุญ!")
            st.rerun()

    st.divider()
    st.subheader("๐ ููุฎุต ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ")
    st.dataframe(get_data(), use_container_width=True)

if role == "admin" and tab2:
    with tab2:
        st.subheader("โ๏ธ ุฅุฏุงุฑุฉ ูุชุนุฏูู ูุงูุฉ ุงูุดููุฑ")
        data_to_edit = get_data()
        edited_df = st.data_editor(data_to_edit, num_rows="dynamic", use_container_width=True, key="editor_tab2")
        if st.button("๐พ ุญูุธ ุฌููุน ุงูุชุบููุฑุงุช ุงูููุงุฆูุฉ"):
            conn.update(data=edited_df)
            st.cache_data.clear()
            st.success("ุชู ุงูุชุญุฏูุซ ุงูุณุญุงุจู ุงูุดุงูู!")
            st.rerun()