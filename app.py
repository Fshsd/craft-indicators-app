import streamlit as st
import pandas as pd
from streamlit_gsheets import GSheetsConnection

# ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ
st.set_page_config(page_title="ูุธุงู ุฅุฏุงุฑุฉ ูุคุดุฑุงุช ุงูุญุฑู", layout="wide")

# ุฅูุดุงุก ุงูุงุชุตุงู ุจุฌูุฌู ุดูุช (ุณููุฑุฃ ุงูุจูุงูุงุช ุชููุงุฆูุงู ูู secrets.toml)
conn = st.connection("gsheets", type=GSheetsConnection)

def get_data():
    # ุงุณุชุฎุฏุงู ttl=0 ูุฎุจุฑ Streamlit ุฃูุง ูุญุชูุธ ุจุงูุจูุงูุงุช ุงููุฏููุฉ ููุฌูุจ ุงูุฌุฏูุฏ ููุฑุงู
    return conn.read(ttl=2)

# ุงูุจูุงูุงุช ุงูุซุงุจุชุฉ
INDICATORS = [
    "ูุณุจุฉ ุฅุบูุงู ุงูุทูุจุงุช ุงููุงุฑุฏุฉ ูู ููุตุฉ ุฃุจุฏุน ููุชุฑุงุฎูุต ุงูุญุฑููุฉ", "ุนุฏุฏ ุงูุฑุฎุต ุงููุตุฏุฑุฉ ูู ุฑุฎุตุฉ ููุงุฑุณ ุญุฑูู",
    "ุนุฏุฏ ุงูุฑุฎุต ุงููุตุฏุฑุฉ ูู ุฑุฎุตุฉ ูุญู ุจูุน ููุชุฌุงุช ุญุฑููุฉ ุชุฑุงุซูุฉ ูุฏููุฉ", "ุนุฏุฏ ุงูุญุฑูููู ุงููุณุฌููู ูู ุงูุณุฌู ุงููุทูู ููุญุฑูููู",
    "ุนุฏุฏ ุงููุชุจ ุนู ุงูุญุฑู ุงููุฏููุฉ", "ุนุฏุฏ ุงูุจุญูุซ ุนู ุงูุญุฑู ุงููุฏููุฉ", "ุนุฏุฏ ุงูุจููุช ุงูุญุฑููุฉ ุงููุดุทุฉ",
    "ุนุฏุฏ ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ููุฑุด ุงูุนูู ููุจููุช ุงูุญุฑููุฉ ููุท", "ุนุฏุฏ ุงููุณุชููุฏูู ุงูุญุงูููู ูู ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ุงูููุฏูุฉ ููุจููุช ุงูุญุฑููุฉ ููุท",
    "ุนุฏุฏ ุงููุชุฏุฑุจูู ุฎูุงู ุจุฏุงูุฉ ูุฑุญูุฉ ุชุฏุฑูุจูุฉ ููุจููุช ุงููุงุฆูุฉ", "ุนุฏุฏ ุงูุฎุฑูุฌูู ูู ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ุงูููุฏูุฉ ูู ุงูุจููุช ุงูุญุฑููุฉ ููุท",
    "ุนุฏุฏ ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ููุฑุด ุงูุนูู ููุงูุฉ ุงููุดุงุฑูุน ุฏูู ุงูุจููุช ุงูุญุฑููุฉ", "ุนุฏุฏ ุงููุณุชููุฏูู ูู ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ุงูููุฏูุฉ ููุงูุฉ ุงููุดุงุฑูุน ุฏูู ุงูุจููุช ุงูุญุฑููุฉ",
    "ุนุฏุฏ ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ููุฑุด ุงูุนูู ููุฃุทูุงู", "ุนุฏุฏ ุงููุณุชููุฏูู ูู ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ ููุฑุด ุงูุนูู ุงูููุฏูุฉ ููุฃุทูุงู",
    "ุนุฏุฏ ุงููุทุน ุงูุญุฑููุฉ ุงูููุชุฌุฉ ูู ุฃุนูุงู ุงูุจููุช ุงูุญุฑููุฉ", "ุนุฏุฏ ุงููุทุน ุงูุญุฑููุฉ ุงูููุชุฌุฉ ูู ุฃุนูุงู ููุดุงุฑูุน ุงููุทุงุน",
    "ุนุฏุฏ ุงูุชุตุงููู ุงูุตุงุฏุฑุฉ ูู ูุดุงุฑูุน ุงูุจููุช ุงูุญุฑููุฉ", "ุนุฏุฏ ุงูุชุตุงููู ุงูุตุงุฏุฑุฉ ูู ูุงูุฉ ูุดุงุฑูุน ูุทุงุน ุงูุญุฑู",
    "ุนุฏุฏ ุงููุนุงุฑุถ ูุงููุนุงููุงุช ุงูุฏูููุฉ", "ุนุฏุฏ ุงููุนุงุฑุถ ูุงููุนุงููุงุช ุงููุญููุฉ", "ุนุฏุฏ ุงูุญุฑูููู ุงููุดุงุฑููู ูู ุงููุนุงุฑุถ ุงูุฏูููุฉ",
    "ุนุฏุฏ ุงูุญุฑูููู ุงููุดุงุฑููู ูู ุงููุนุงุฑุถ ุงููุญููุฉ", "ุนุฏุฏ ุงูุญุฑูููู ุงููุฏุนูููู ููุฌุณุชูุงู", "ุนุฏุฏ ุงููุทุงุนุงุช ุบูุฑ ุงูุฑุจุญูุฉ ุงููุณุชููุฏุฉ",
    "ุนุฏุฏ ุงูุฌูุงุฆุฒ ุงููุชูุฏู ุนูููุง ูุทุงุน ุงูุญุฑู", "ุนุฏุฏ ุงูุฌูุงุฆุฒ ุงูุญุงุตู ุนูููุง ูุทุงุน ุงูุญุฑู", "ุนุฏุฏ ุงููุดุงุฑูุงุช ุงูุจุญุซูุฉ",
    "ุนุฏุฏ ุงูุญุฑูููู ุงููุณุชููุฏูู ูู ุงูุฏุนู ุงููุงูู", "ูููุฉ ุงูุฏุนู ุงููุงูู ุงูููุฏู", "ุนุฏุฏ ุงูุญุฑูููู ุงููุณุชููุฏูู ูู ุฏุนู ุงููุนุงููุงุช",
    "ูููุฉ ุงูุฏุนู ุงููุงูู ุนุจุฑ ุงููุนุงููุงุช", "ุนุฏุฏ ุงูููุงูุงุช ุงููุณุชููุฏุฉ ูู ุงูุฏุนู", "ูููุฉ ุงูุฏุนู ุงููุงูู ููููุงูุงุช"
]

FOLLOW_UP_LIST = [
    "ุดูุฑู","ุชุฑุงููู","ุชุฑุงููู","ุชุฑุงููู","ุดูุฑู","ุดูุฑู","ุชุฑุงููู",
    "ุดูุฑู","ุดูุฑู","ุดูุฑู","ุดูุฑู","ุดูุฑู","ุดูุฑู","ุดูุฑู","ุดูุฑู",
    "ุดูุฑู","ุดูุฑู","ุดูุฑู","ุดูุฑู","ุดูุฑู","ุดูุฑู","ุดูุฑู","ุดูุฑู",
    "ุดูุฑู","ุดูุฑู","ุดูุฑู","ุดูุฑู","ุดูุฑู","ุฑุจุนู","ุฑุจุนู","ุฑุจุนู",
    "ุฑุจุนู","ุฑุจุนู","ุฑุจุนู",
]

# 2. ุงูุฑุจุท ุงูุตุญูุญ ุจูู ุงุณู ุงููุคุดุฑ ูุทุฑููุฉ ุงููุชุงุจุนุฉ
if len(INDICATORS) == len(FOLLOW_UP_LIST):
    FOLLOW_UP_MAPPING = dict(zip(INDICATORS, FOLLOW_UP_LIST))
else:
    # ูู ุญุงู ูุฌูุฏ ุงุฎุชูุงู ูู ุงูุนุฏุฏุ ูุนุชูุฏ ุนูู ุงูุจุญุซ ุนู ูููุฉ "ุชุฑุงููู" ูุฎุทุฉ ุจุฏููุฉ
    FOLLOW_UP_MAPPING = {ind: ("ุชุฑุงููู" if "ุชุฑุงููู" in ind else "ุดูุฑู") for ind in INDICATORS}
OWNERS = ["ูุญูุฏ ุงูุนุซูุงู","ุญูุงู ุงูุตุญู","ุงููููู ุงููุนุจูู","ุฏููุง ุงูุญููุฏู","ุฑูู ุงูุญููุฏ","ููุง ุงูุบุงููู","ุตุงูุญ ุจู ุฏุฑููู","ุนุจุฏุงููู ุงูุฑุจููุน","ููุงู ุงูุฑุงุฌุญู"]

st.title("๐ ูุธุงู ุฅุฏุงุฑุฉ ูุคุดุฑุงุช ูุทุงุน ุงูุญุฑู")
tab1, tab2 = st.tabs(["โ ุฅุถุงูุฉ ุจูุงูุงุช", "๐ ุนุฑุถ ูุชุนุฏูู ูุฅุฏุงุฑุฉ"])

# ===============================
# ูุธุงู ุงูุญูุงูุฉ ุจุฑูุฒ PIN
# ===============================
def check_password():
    """Returns `True` if the user had the correct password."""

    def password_entered():
        """Checks whether a password entered by the user is correct."""
        if st.session_state["password"] == "1424":  # ุถุน ุงูุฑูุฒ ุงูุฐู ุชุฑูุฏู ููุง
            st.session_state["password_correct"] = True
            del st.session_state["password"]  # ูุณุญ ุงูุฑูุฒ ูู ุงูุฐุงูุฑุฉ ููุฃูุงู
        else:
            st.session_state["password_correct"] = False

    if "password_correct" not in st.session_state:
        # ุนุฑุถ ูุงุฌูุฉ ุฅุฏุฎุงู ุงูุฑูุฒ ุงูุณุฑู ูุฃูู ูุฑุฉ
        st.text_input(
            "ุฃุฏุฎู ุงูุฑูุฒ ุงูุณุฑู ููุฏุฎูู ุฅูู ุงููุธุงู", 
            type="password", 
            on_change=password_entered, 
            key="password"
        )
        return False
    elif not st.session_state["password_correct"]:
        # ูู ุญุงู ูุงู ุงูุฑูุฒ ุฎุทุฃ
        st.text_input(
            "ุงูุฑูุฒ ุงูุณุฑู ุฎุงุทุฆุ ุญุงูู ูุฑุฉ ุฃุฎุฑู", 
            type="password", 
            on_change=password_entered, 
            key="password"
        )
        st.error("๐ ุงูุฑูุฒ ุบูุฑ ุตุญูุญ")
        return False
    else:
        # ุงูุฑูุฒ ุตุญูุญ
        return True

# ุงูุชุญูู ูู ุงูุฏุฎูู ูุจู ุนุฑุถ ุฃู ุดูุก
if not check_password():
    st.stop()  # ูุชููู ุงูููุฏ ููุง ููุง ูุนุฑุถ ุงูุชุจููุจุงุช ุฃู ุงูุจูุงูุงุช ุฅูุง ุจุนุฏ ุฅุฏุฎุงู ุงูุฑูุฒ

with tab1:
    st.subheader("ุฅุฏุฎุงู ุณุฌู ุฌุฏูุฏ")
    
    ind_name = st.selectbox("ุงุณู ุงููุคุดุฑ", INDICATORS)
    f_method = FOLLOW_UP_MAPPING.get(ind_name, "ุบูุฑ ูุญุฏุฏ")
    st.info(f"ุทุฑููุฉ ุงููุชุงุจุนุฉ ููุฐุง ุงููุคุดุฑ: **{f_method}**")

    with st.form("add_form", clear_on_submit=True):
        c1, c2 = st.columns(2)
        with c1:
            owner_name = st.selectbox("ูุงูู ุงููุคุดุฑ", OWNERS)
            base_24 = st.number_input("ุฎุท ุงูุฃุณุงุณ 2024", value=0.0)
        with c2:
            act_25 = st.number_input("ุงููููุฉ ุงููุนููุฉ (ุฃุบุณุทุณ 2025)", value=0.0)
            docs_input = st.text_input("ุงููุซุงุฆู ุงูุฏุงุนูุฉ")

        if st.form_submit_button("ุญูุธ ูู ุงูุณุญุงุจุฉ โ"):
            # 1. ุฅุธูุงุฑ ุณุจููุฑ ุฃุซูุงุก ุนูููุฉ ุงูุฅุฑุณุงู ููุณุญุงุจุฉ
            with st.spinner('ุฌุงุฑู ุญูุธ ุงูุจูุงูุงุช ูุชุญุฏูุซ ุงูุณุญุงุจุฉ...'):
                new_row = pd.DataFrame([{
                    "ุงุณู ุงููุคุดุฑ": ind_name, "ูุงูู ุงููุคุดุฑ": owner_name,
                    "ุฎุท ุงูุฃุณุงุณ 2024": base_24, "ุงููุนููุฉ ุฃุบุณุทุณ 2025": act_25,
                    "ุงููุซุงุฆู ุงูุฏุงุนูุฉ": docs_input, "ุทุฑููุฉ ุงููุชุงุจุนุฉ": f_method
                }])

                # ุฌูุจ ุงูุจูุงูุงุช ุงูุญุงููุฉ (ูุฑุฉ ูุงุญุฏุฉ ููุท)
                current_df = get_data()
                updated_df = pd.concat([current_df, new_row], ignore_index=True)
                
                # ุชุญุฏูุซ ุงูุณุญุงุจุฉ
                conn.update(data=updated_df)
                
                # ูุณุญ ุงููุงุด ูุถูุงู ุธููุฑ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ
                st.cache_data.clear()
            
            st.success("ุชู ุงูุญูุธ ุจูุฌุงุญ!")
            st.rerun() # ููุง ูุชููู ุงูููุฏ ููุนูุฏ ุงูุชุดุบูู ูู ุงูุจุฏุงูุฉ

    # 2. ุนุฑุถ ุงูุฌุฏูู ุฃุณูู ุงูููุฑู (ุฎุงุฑุฌ ุดุฑุท ุงูุถุบุท ุนูู ุงูุฒุฑ)
    st.markdown("---")
    st.subheader("๐ ุงูุจูุงูุงุช ุงููุณุฌูุฉ ุญุงููุงู")
    
    with st.spinner('ุฌุงุฑู ุฌูุจ ุฃุญุฏุซ ุงูุจูุงูุงุช...'):
        data = get_data()
        st.dataframe(data, use_container_width=True)

with tab2:
    st.subheader("โ๏ธ ุฅุฏุงุฑุฉ ูุชุนุฏูู ุงูุจูุงูุงุช")
    data_to_edit = get_data()
    edited_df = st.data_editor(data_to_edit, num_rows="dynamic", use_container_width=True, key="editor_tab2")
    
    if st.button("๐พ ุญูุธ ุฌููุน ุงูุชุบููุฑุงุช ุงูููุงุฆูุฉ"):
        with st.spinner('ุฌุงุฑู ุญูุธ ุงูุจูุงูุงุช ูุชุญุฏูุซ ุงูุณุญุงุจุฉ...'):
            conn.update(data=edited_df)
            
            # --- ุงูุณุทุฑ ุงูุณุญุฑู ูุญู ูุดููุชู ---
            st.cache_data.clear() # ููุณุญ ุงูุฐุงูุฑุฉ ุงููุฏููุฉ ููุฌุจุฑ ุงูุชุทุจูู ุนูู ุฌูุจ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ูู ูู ุงูุชุจููุจุงุช
            
            st.success("ุชู ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ! ๐")
            st.rerun()